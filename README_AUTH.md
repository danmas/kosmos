# Аутентификация и отладка SSH в Kosmos Panel

Этот файл описывает, как настраивать доступ по SSH для панели, как работает «горячая» перезагрузка конфигурации, и как отлаживать проблемы подключения терминала и tail логов.

## Где настраивается

Все настройки лежат в `inventory.json`:
- Блок `credentials`: описывает способы аутентификации (ключ/пароль/агент)
- Поле `ssh` у каждого сервера: указывает `host`, `port`, `user`, `credentialId`

Пример:
```json
{
  "credentials": [
    {
      "id": "cred-sample",
      "type": "ssh-key",
      "privateKeyPath": "C:/Users/you/.ssh/id_ed25519",
      "passphrase": null,
      "useAgent": false,
      "password": null
    }
  ],
  "servers": [
    {
      "id": "usa",
      "name": "usa",
      "env": "prod",
      "ssh": { "host": "usa", "port": 22, "user": "ubuntu", "credentialId": "cred-sample" },
      "services": [
        { "id": "usa-web", "type": "http", "name": "USA Web", "url": "http://usa:3002", "expectStatus": 200 }
      ]
    }
  ]
}
```

Поддерживаемые поля в `credentials`:
- `type`: всегда `ssh-key` (для ключей)
- `privateKeyPath`: путь до приватного ключа (например, `C:/Users/<ты>/.ssh/id_ed25519`)
- `passphrase`: пароль к ключу, если он установлен
- `useAgent`: если `true`, панель попробует использовать SSH‑агент (`SSH_AUTH_SOCK` или Pageant на Windows)
- `password`: опционально, пароль для логина по паролю (не рекомендуется; только для отладки)

Примечания для Windows:
- Часто ключ — `id_ed25519`, а не `id_rsa`
- Путь указывайте Windows‑стилем, например `C:/Users/<ты>/.ssh/id_ed25519`

## Горячая перезагрузка конфигурации

Панель автоматически перечитывает `inventory.json` при изменении:
- Срабатывает файловый вотчер
- Конфиг полностью обновляется «на лету»
- Кэш ключей очищается, новые пути/пароли берутся при следующем подключении
- Запускается немедленный `pollOnce()` (обновление статусов)

Также есть ручной эндпойнт:
- `POST /api/reload` — принудительно перечитать конфиг

Важно: уже открытые SSH‑сессии (терминал/tail) не перенастраиваются — откройте новую сессию.

## Проверка соединения по SSH (диагностика)

Быстрый тест с сервера панели:
- Откройте в браузере: `http://localhost:3000/api/test-ssh?serverId=<id>`
- Успех:
  ```json
  { "ok": true, "result": { "stdout": "__OK__" } }
  ```
- Ошибка: будет `{ ok:false, error:"..." }` — по тексту станет ясно, проблема в ключе/пароле/юзере/сетке

Проверка доступности порта 22 (Windows PowerShell):
```
Test-NetConnection <host> -Port 22
```
Ожидаем `TcpTestSucceeded: True`.

## Отладка терминала и tail

- UI пишет причины ошибок во всплывающем оверлее (сообщения `[FATAL] ...`)
- На сервере панели смотрите консоль `node` — логи `"[ws] terminal ..."`/`"[ws] tail ..."` и ошибки ssh2
- Типовые проблемы и решения:
  - Неверный путь к ключу → проверьте `privateKeyPath`
  - Ключ с паролем → укажите `passphrase`
  - Неверный `user` → поправьте `ssh.user` у сервера
  - Доступ закрыт фаерволом → проверьте `Test-NetConnection`
  - Нужен агент → установите `useAgent: true` (Pageant/OpenSSH Agent), и загрузите ключ в агент
  - В крайнем случае, для быстрой проверки можно временно задать `password` в `credentials`

## Безопасность

- Не храните приватные ключи в репозитории
- Использование `password` допустимо только временно для отладки
- Предпочтительно — ключи с `passphrase` или SSH‑агент

## Поведение терминала (WS)

- Эндпойнт: `/ws/terminal?serverId=...&cols=120&rows=30`
- При ошибке аутентификации UI покажет `[FATAL] ...` с причиной
- После изменения кредов откройте новую вкладку терминала

## Tail логов (WS)

- Эндпойнт: `/ws/tail?serverId=...&path=/var/log/syslog&lines=200`
- Использует те же креды SSH, что и терминал
- При ошибке также придёт `[FATAL] ...`


