# Редактор Inventory.json — Документация

## Обзор

Встроенный веб-редактор для управления конфигурацией серверов и мониторинга в Kosmos Panel. Предоставляет удобный интерфейс для редактирования файла `inventory.json` с валидацией, предварительным просмотром и автоматическим резервным копированием.

## Доступ к редактору

### Веб-интерфейс
- **URL**: `http://localhost:3000/inventory-editor.html`
- **Кнопка**: "⚙️ Настройки" в верхней панели главной страницы

### Горячие клавиши
- `Ctrl+S` — сохранить изменения
- `Ctrl+Shift+F` — автоматическое форматирование JSON

## Структура интерфейса

### 1. Заголовок (Header)
- **Кнопка "← Назад"** — возврат к главной панели мониторинга
- **Панель действий**:
  - `Форматировать` — приведение JSON к читаемому виду
  - `Проверить` — ручная валидация JSON
  - `Сохранить` — сохранение изменений (также Ctrl+S)
  - `Перезагрузить` — загрузка файла заново (с подтверждением)

### 2. Боковая панель (Sidebar)
- **Список серверов** — навигация по серверам с отображением:
  - Название сервера
  - Окружение (prod/test/dev)
  - Количество сервисов
- **Кнопки быстрого добавления**:
  - `Добавить сервер` — добавляет шаблон нового сервера
  - `Добавить ключ` — добавляет шаблон новых учетных данных

### 3. Основная область (Content)
#### Вкладка "JSON"
- **Редактор кода** с возможностями:
  - Подсветка синтаксиса JSON
  - Автоматические отступы
  - Валидация в реальном времени
  - Номера строк и позиция курсора

#### Вкладка "Предварительный просмотр"
- **Структурированное отображение**:
  - Список серверов с группировкой по окружениям
  - Детали SSH-подключения
  - Перечень сервисов для каждого сервера
  - Список учетных данных
  - Настройки опроса

### 4. Статус-бар (Status Bar)
- **Информация о файле**:
  - Позиция курсора (строка, столбец)
  - Размер файла (КБ и байты)
  - Статус валидации JSON
- **Индикатор сохранения**:
  - Зеленая точка — сохранено
  - Желтая точка — идет сохранение
  - Красная точка — ошибка

## Валидация данных

### Клиентская валидация
Выполняется в реальном времени при редактировании:

1. **Синтаксис JSON** — проверка корректности JSON-структуры
2. **Обязательные поля**:
   - `credentials` (массив)
   - `servers` (массив) 
   - `poll` (объект)
3. **Структура серверов**:
   - `id`, `name` — обязательные строки
   - `ssh.host`, `ssh.user` — обязательные поля SSH
   - `services` — массив сервисов
4. **Структура учетных данных**:
   - `id`, `type` — обязательные поля

### Серверная валидация
Выполняется при сохранении на сервере:

1. **Уникальность ID** серверов и учетных данных
2. **Связность данных** — проверка существования `credentialId`
3. **Корректность типов** сервисов
4. **Дополнительная структурная валидация**

## API Endpoints

### GET /inventory.json
Загружает текущий файл конфигурации для редактирования.

**Ответ:**
- **200** — содержимое файла inventory.json
- **404** — файл не найден
- **500** — ошибка чтения файла

### POST /api/inventory
Сохраняет новую конфигурацию с полной валидацией.

**Тело запроса:**
```json
{
  "credentials": [...],
  "servers": [...],
  "poll": { "intervalSec": 15, "concurrency": 6 }
}
```

**Ответ:**
- **200** — `{"ok": true, "message": "Файл успешно сохранен"}`
- **400** — ошибка валидации с описанием
- **500** — системная ошибка

## Функции безопасности

### Резервное копирование
При каждом сохранении создается автоматическая резервная копия:
```
inventory.json.backup.1703234567890
```

### Валидация входных данных
- Проверка всех обязательных полей
- Валидация типов данных
- Контроль уникальности идентификаторов
- Санитизация пользовательского ввода

### Предотвращение потери данных
- Предупреждение при закрытии страницы с несохраненными изменениями
- Подтверждение при перезагрузке файла
- Автоматическая проверка перед сохранением

## Шаблоны по умолчанию

### Новый сервер
```json
{
  "id": "new-server",
  "name": "Новый сервер", 
  "env": "test",
  "ssh": {
    "host": "127.0.0.1",
    "port": 22,
    "user": "ubuntu",
    "credentialId": "cred-sample"
  },
  "services": [
    {
      "id": "web",
      "type": "http",
      "name": "Web",
      "url": "http://127.0.0.1:80/",
      "expectStatus": 200,
      "timeoutMs": 2000
    }
  ]
}
```

### Новые учетные данные
```json
{
  "id": "new-credential",
  "type": "ssh-key",
  "privateKeyPath": "${SSH_KEY_PATH}",
  "passphrase": "${SSH_PASSPHRASE}",
  "password": "${SSH_PASSWORD}",
  "useAgent": "${USE_SSH_AGENT}"
}
```

## Поддерживаемые типы сервисов

1. **http** — HTTP-запрос с проверкой статус-кода
2. **httpJson** — HTTP с валидацией JSON-ответа по JSONPath
3. **tcp** — проверка TCP-подключения к порту
4. **tls** — проверка срока действия TLS-сертификата
5. **systemd** — статус systemd-сервиса
6. **sshCommand** — выполнение команды по SSH
7. **dockerContainer** — статус Docker-контейнера

## Устранение неполадок

### Файл не загружается
- Проверьте права доступа к `inventory.json`
- Убедитесь, что файл существует в корне проекта
- Проверьте синтаксис JSON в существующем файле

### Ошибки валидации
- Используйте встроенное форматирование (Ctrl+Shift+F)
- Проверьте обязательные поля в сообщениях об ошибках
- Убедитесь в уникальности всех ID

### Проблемы с сохранением
- Проверьте права на запись в директорию проекта
- Убедитесь, что сервер запущен и доступен
- Проверьте консоль браузера на наличие ошибок JavaScript

## Интеграция с основной панелью

После сохранения изменений в редакторе:
1. Автоматически вызывается `POST /api/reload`
2. Сервер перезагружает конфигурацию
3. Изменения отражаются в основной панели мониторинга
4. Обновляется список серверов и сервисов

Это обеспечивает бесшовную интеграцию между редактором и панелью мониторинга.
