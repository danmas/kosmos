# Система логирования терминала в Kosmos Panel

Kosmos Panel ведет детальный лог всех взаимодействий с терминалом, включая AI запросы, выполненные команды и их результаты. Все записи связываются между собой через уникальные ID для отслеживания полной цепочки взаимодействий.

## Обзор

### Основные возможности
- ✅ **Связанные записи** - отслеживание цепочки: AI запрос → команда → результат
- ✅ **Фильтрация эхо** - исключение технических записей (эхо ввода команд)
- ✅ **Интерактивная панель** - просмотр лога при наведении в терминале
- ✅ **Веб-интерфейсы** - отдельные страницы для просмотра логов
- ✅ **JSON API** - программный доступ к логам

### Файлы системы
- `terminal_log.json` - основной файл логов
- `web/logs.html` - интерфейс просмотра с группировкой
- `web/raw-logs.html` - просмотр исходного JSON
- `web/term.html` - интерактивная панель в терминале

## Структура записей

### Базовые поля
Каждая запись содержит:
```json
{
  "id": "uuid-записи",
  "sessionId": "uuid-сессии",
  "timestamp": "2025-08-25T08:35:50.762Z",
  "type": "тип-записи",
  "serverId": "идентификатор-сервера",
  "serverName": "название-сервера", 
  "serverHost": "хост-сервера"
}
```

### Типы записей

#### 1. AI запрос (`ai_query`)
```json
{
  "id": "ai-query-123",
  "sessionId": "session-456",
  "timestamp": "2025-08-25T08:35:50.762Z",
  "type": "ai_query",
  "user_ai_query": "показать диски",
  "serverId": "usa",
  "serverName": "USA Server",
  "serverHost": "192.168.1.100"
}
```

#### 2. Команда (`stdin`)
```json
{
  "id": "stdin-789",
  "sessionId": "session-456", 
  "timestamp": "2025-08-25T08:35:51.100Z",
  "type": "stdin",
  "executed_command": "df -h",
  "ai_query_id": "ai-query-123",  // Связь с AI запросом (опционально)
  "user_ai_query": "показать диски",  // Дублирование для совместимости
  "serverId": "usa",
  "serverName": "USA Server",
  "serverHost": "192.168.1.100"
}
```

#### 3. Результат выполнения (`stdout`)
```json
{
  "id": "stdout-101",
  "sessionId": "session-456",
  "timestamp": "2025-08-25T08:35:51.500Z", 
  "type": "stdout",
  "terminal_output": "Filesystem      Size  Used Avail Use%...",
  "stdin_id": "stdin-789",  // Связь с командой
  "serverId": "usa",
  "serverName": "USA Server",
  "serverHost": "192.168.1.100"
}
```

#### 4. Ошибки (`stderr`)
```json
{
  "id": "stderr-102",
  "sessionId": "session-456",
  "timestamp": "2025-08-25T08:35:51.600Z",
  "type": "stderr", 
  "terminal_output": "command not found: xyz",
  "stdin_id": "stdin-789",  // Связь с командой
  "serverId": "usa",
  "serverName": "USA Server",
  "serverHost": "192.168.1.100"
}
```

## Связи между записями

### Схема связей
```
AI Query (id: A) 
    ↓ ai_query_id: A
Command (id: B)
    ↓ stdin_id: B  
Output (stdout/stderr)
```

### Поля связей
- **`ai_query_id`** - в stdin записях, указывает на AI запрос, который сгенерировал команду
- **`stdin_id`** - в stdout/stderr записях, указывает на команду, которая дала этот вывод

### Примеры поиска по связям

**Найти все команды от AI запроса:**
```javascript
const aiQueryId = "ai-query-123";
const commands = logs.filter(log => 
  log.type === 'stdin' && log.ai_query_id === aiQueryId
);
```

**Найти результат команды:**
```javascript
const commandId = "stdin-789";
const outputs = logs.filter(log => 
  (log.type === 'stdout' || log.type === 'stderr') && 
  log.stdin_id === commandId
);
```

**Найти команды определенного сервера:**
```javascript
const serverId = "usa";
const serverCommands = logs.filter(log => 
  log.type === 'stdin' && log.serverId === serverId
);
```

**Найти все записи сервера за период:**
```javascript
const serverId = "usa";
const startDate = new Date('2025-08-25T00:00:00Z');
const endDate = new Date('2025-08-25T23:59:59Z');

const serverLogs = logs.filter(log => 
  log.serverId === serverId &&
  new Date(log.timestamp) >= startDate &&
  new Date(log.timestamp) <= endDate
);
```

## Мультисерверная поддержка

Kosmos Panel поддерживает одновременную работу с несколькими серверами. Каждая запись в логе автоматически содержит информацию о сервере, на котором была выполнена команда.

### Автоматическое определение сервера
При подключении к терминалу сервер автоматически добавляет в каждую запись:
- **`serverId`** - уникальный идентификатор сервера из конфигурации
- **`serverName`** - человеко-читаемое название сервера
- **`serverHost`** - IP адрес или hostname сервера

### Сценарии использования

**Отладка проблем на конкретном сервере:**
```javascript
// Найти все ошибки на сервере "prod"
const prodErrors = logs.filter(log => 
  log.serverId === 'prod' && log.type === 'stderr'
);
```

**Сравнение команд между серверами:**
```javascript
// Сравнить использование команды 'df' на разных серверах
const dfCommands = logs.filter(log => 
  log.type === 'stdin' && log.executed_command.includes('df')
).reduce((acc, log) => {
  if (!acc[log.serverId]) acc[log.serverId] = 0;
  acc[log.serverId]++;
  return acc;
}, {});
```

**Аудит активности:**
```javascript
// Получить статистику команд по серверам
const serverStats = logs.reduce((acc, log) => {
  if (log.type !== 'stdin') return acc;
  const server = log.serverId;
  if (!acc[server]) acc[server] = { commands: 0, aiCommands: 0 };
  acc[server].commands++;
  if (log.ai_query_id) acc[server].aiCommands++;
  return acc;
}, {});
```

## Интерфейсы просмотра

### 1. Интерактивная панель в терминале
**Расположение:** `/term.html` (правая панель)
**Функции:**
- Показ логов для команды под курсором
- Отображение связанных AI запросов и результатов
- Индикатор активности лога

### 2. Страница логов с группировкой  
**URL:** `/logs.html`
**Функции:**
- Группировка связанных записей
- Фильтрация по серверам (выпадающий список)
- Навигация по командам (Prev/Next, стрелки, K/J)
- Автообновление каждые 30 секунд
- Фильтрация ANSI кодов
- Отображение связей между записями и информации о сервере

### 3. Raw JSON просмотр
**URL:** `/raw-logs.html`
**Функции:**
- Исходный JSON с подсветкой синтаксиса
- Скачивание файла логов
- Информация о размере и времени изменения
- Автообновление каждые 60 секунд

## API

### Получение логов
```http
GET /api/logs
```
**Ответ:** JSON массив всех записей лога

**Пример использования:**
```javascript
fetch('/api/logs')
  .then(response => response.json())
  .then(logs => {
    console.log(`Получено ${logs.length} записей`);
  });
```

## Техническая реализация

### Backend (server/ws.js)

#### Логика записи
1. **AI команды:** При получении `ai_query` создается запись с уникальным ID
2. **Обычные команды:** При получении `command_log` создается stdin запись
3. **Результаты:** При обнаружении промпта в stdout записывается результат
4. **Связывание:** ID сохраняются в переменных для связи записей

#### Определение завершения команды
```javascript
const promptRegex = /\w+@\w+[^$#>]*[\$#>]\s*$/m;
if (promptRegex.test(stdoutBuffer)) {
  // Команда завершилась, записываем результат
}
```

#### Фильтрация эхо команд
```javascript
if (cleanOutput && !cleanOutput.includes('ai:')) {
  // Записываем только полезный вывод
}
```

### Frontend

#### Группировка записей (logs.html)
```javascript
function groupLogs() {
  // Поиск связанных записей через ai_query_id и stdin_id
  // Создание групп: AI запрос + команда + результат
}
```

#### Поиск в терминале (term.html)
```javascript
function findLogEntriesForCommand(log, command) {
  // Поиск stdin записи с точным совпадением команды
  // Поиск связанных ai_query и stdout записей через ID
}
```

## Конфигурация

### Переменные окружения
```bash
# В .env файле (необязательно, есть значения по умолчанию)
TERMINAL_LOG_FILE=terminal_log.json
TERMINAL_LOG_MAX_SIZE=10485760  # 10MB
```

### Настройки автоочистки
Логи очищаются автоматически при превышении лимита размера файла (по умолчанию не реализовано).

## Отладка

### Включение debug логов
В браузере (F12 → Console):
```javascript
// Временно включить debug логи в терминале
localStorage.setItem('terminal_debug', 'true');
```

### Проверка связей
```javascript
// Проверить целостность связей в логе
fetch('/api/logs')
  .then(r => r.json())
  .then(logs => {
    const broken = logs.filter(log => 
      log.ai_query_id && !logs.find(l => l.id === log.ai_query_id)
    );
    console.log('Broken ai_query_id links:', broken.length);
  });
```

## Лучшие практики

### Для разработчиков
1. **Всегда связывайте записи** - используйте ai_query_id и stdin_id
2. **Фильтруйте технические данные** - эхо команд, ANSI коды
3. **Проверяйте целостность** - убеждайтесь что связи существуют
4. **Обрабатывайте ошибки** - stderr записи тоже должны быть связаны

### Для пользователей
1. **Используйте страницу логов** - `/logs.html` для анализа команд
2. **Фильтрация по серверам** - выберите сервер в выпадающем списке для фокуса на конкретной машине
3. **Горячие клавиши** - K/J или стрелки для навигации
4. **Raw лог** - `/raw-logs.html` для программного анализа
5. **Интерактивная панель** - наведение на команды в терминале

### Для работы с несколькими серверами
1. **Используйте фильтр серверов** - для анализа активности конкретного сервера
2. **Мониторинг ошибок** - фильтруйте по серверу и типу записи для поиска проблем
3. **Сравнительный анализ** - используйте Raw JSON для сравнения поведения команд на разных серверах
4. **Аудит безопасности** - отслеживайте выполнение критичных команд по серверам

## Решение проблем

### Команды не связываются
**Причина:** Неправильное определение завершения команды
**Решение:** Проверить регекс промпта, добавить debug логи

### Дублированные AI записи  
**Причина:** Эхо команд попадает в лог
**Решение:** Улучшить фильтрацию в `checkForPromptAndFlush()`

### Потеря связей при перезапуске
**Причина:** ID сохраняются только в памяти
**Решение:** Использовать sessionId для восстановления связей

### Большой размер лога
**Причина:** Накопление записей без очистки
**Решение:** Реализовать ротацию логов или автоочистку старых записей
