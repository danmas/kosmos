<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>–õ–æ–≥ –∫–æ–º–∞–Ω–¥ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body { height:100%; margin:0; background:#0b0f1a; color:#e6ecff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
      .wrap { height:100%; display:flex; flex-direction:column; }
      .header { 
        padding:12px 20px; 
        background:#0e1322; 
        border-bottom:1px solid #1c2333; 
        display:flex; 
        justify-content:space-between; 
        align-items:center; 
      }
      .title { font-weight:700; font-size:18px; }
      .nav-controls { display:flex; gap:8px; align-items:center; }
      .nav-info { 
        font-size:13px; 
        color:#888; 
        padding:6px 12px; 
        background:#1b2544; 
        border-radius:6px; 
      }
      .main { flex:1; display:flex; overflow:hidden; }
      .sidebar { 
        width:300px; 
        background:#0e1322; 
        border-right:1px solid #1c2333; 
        display:flex; 
        flex-direction:column; 
      }
      .sidebar-header { 
        padding:10px 12px; 
        background:#1b2544; 
        border-bottom:1px solid #223055; 
        font-weight:600; 
        font-size:13px; 
      }
      .log-list { 
        flex:1; 
        overflow-y:auto; 
        padding:8px 0; 
      }
      .log-item { 
        padding:8px 12px; 
        cursor:pointer; 
        border-bottom:1px solid #1a1f2e; 
        transition:background 0.15s; 
      }
      .log-item:hover { background:#1a1f2e; }
      .log-item.active { background:#2d4a87; }
      .log-item-time { 
        font-size:11px; 
        color:#888; 
        margin-bottom:3px; 
      }
      .log-item-type { 
        font-size:12px; 
        font-weight:600; 
        margin-bottom:2px; 
      }
      .log-item-preview { 
        font-size:11px; 
        color:#ccc; 
        overflow:hidden; 
        white-space:nowrap; 
        text-overflow:ellipsis; 
      }
      .ai-query { color:#ffa500; }
      .stdin { color:#00ff00; }
      .stdout { color:#4a9eff; }
      .stderr { color:#ff6b6b; }
      .content { 
        flex:1; 
        display:flex; 
        flex-direction:column; 
        overflow:hidden; 
      }
      .content-header { 
        padding:10px 16px; 
        background:#1b2544; 
        border-bottom:1px solid #223055; 
        display:flex; 
        justify-content:space-between; 
        align-items:center; 
      }
      .entry-details { 
        flex:1; 
        padding:20px; 
        overflow-y:auto; 
        font-family:'Courier New', monospace; 
      }
      .entry-card { 
        background:#0e1322; 
        border:1px solid #1c2333; 
        border-radius:8px; 
        margin-bottom:16px; 
        overflow:hidden; 
      }
      .entry-header { 
        padding:12px 16px; 
        background:#1b2544; 
        border-bottom:1px solid #223055; 
        display:flex; 
        justify-content:space-between; 
        align-items:center; 
      }
      .entry-type { 
        font-weight:600; 
        font-size:14px; 
      }
      .entry-time { 
        font-size:12px; 
        color:#888; 
      }
      .entry-content { 
        padding:16px; 
        background:#0b0f1a; 
        white-space:pre-wrap; 
        word-break:break-all; 
        font-size:13px; 
        line-height:1.4; 
        border-left:4px solid #4a9eff; 
      }
      .entry-content.ai-query { border-left-color:#ffa500; }
      .entry-content.stdin { border-left-color:#00ff00; }
      .entry-content.stdout { border-left-color:#4a9eff; }
      .entry-content.stderr { border-left-color:#ff6b6b; }
      button { 
        background:#1b2544; 
        border:1px solid #223055; 
        color:#e6ecff; 
        border-radius:6px; 
        padding:6px 12px; 
        cursor:pointer; 
        font-size:12px; 
      }
      button:hover { background:#2d4a87; }
      button:disabled { 
        background:#0e1322; 
        color:#555; 
        cursor:not-allowed; 
      }
      .empty-state { 
        text-align:center; 
        margin-top:100px; 
        color:#888; 
      }
      .loading { 
        text-align:center; 
        margin-top:100px; 
        color:#4a9eff; 
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div class="title">–õ–æ–≥ –∫–æ–º–∞–Ω–¥ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</div>
                  <div class="nav-controls">
            <div class="nav-info" id="navInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button onclick="location.href='/raw-logs.html'">üìÑ Raw JSON</button>
            <button onclick="location.href='/'">‚Üê –ì–ª–∞–≤–Ω–∞—è</button>
            <button onclick="refreshLogs()">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
      </div>
      
      <div class="main">
        <div class="sidebar">
          <div class="sidebar-header">–°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π</div>
          <div class="log-list" id="logList">
            <div class="loading">–ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥...</div>
          </div>
        </div>
        
        <div class="content">
          <div class="content-header">
            <div id="contentTitle">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏–∑ —Å–ø–∏—Å–∫–∞</div>
            <div>
              <button id="prevBtn" onclick="navigateEntry(-1)" disabled>‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
              <button id="nextBtn" onclick="navigateEntry(1)" disabled>–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
            </div>
          </div>
          <div class="entry-details" id="entryDetails">
            <div class="empty-state">
              <div style="font-size:48px; margin-bottom:16px;">üìã</div>
              <div>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let allLogs = [];
      let currentGroupIndex = -1;
      let logGroups = [];

      async function loadLogs(preserveSelection = false) {
        try {
          const response = await fetch('/api/logs?t=' + Date.now());
          allLogs = await response.json();
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
          const previousIndex = preserveSelection ? currentGroupIndex : -1;
          
          // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º –∫–æ–º–∞–Ω–¥–∞–º
          groupLogs();
          renderLogList();
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–ª–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å
          if (logGroups.length > 0) {
            if (preserveSelection && previousIndex >= 0 && previousIndex < logGroups.length) {
              selectGroup(previousIndex);
            } else if (!preserveSelection) {
              selectGroup(logGroups.length - 1);
            }
          }
          
          updateNavInfo();
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', err);
          document.getElementById('logList').innerHTML = '<div style="color:#ff6b6b; text-align:center; margin-top:50px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤</div>';
        }
      }

      function groupLogs() {
        logGroups = [];
        let currentGroup = null;

        allLogs.forEach(entry => {
          if (entry.type === 'ai_query') {
            // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É —Å AI –∑–∞–ø—Ä–æ—Å–∞
            currentGroup = { entries: [entry], timestamp: entry.timestamp };
            logGroups.push(currentGroup);
          } else if (entry.type === 'stdin') {
            if (entry.user_ai_query) {
              // –ö–æ–º–∞–Ω–¥–∞ —Å–≤—è–∑–∞–Ω–∞ —Å AI –∑–∞–ø—Ä–æ—Å–æ–º
              if (currentGroup) {
                currentGroup.entries.push(entry);
              } else {
                // AI –∑–∞–ø—Ä–æ—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É —Ç–æ–ª—å–∫–æ —Å –∫–æ–º–∞–Ω–¥–æ–π
                currentGroup = { entries: [entry], timestamp: entry.timestamp };
                logGroups.push(currentGroup);
              }
            } else {
              // –û–±—ã—á–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –±–µ–∑ AI
              currentGroup = { entries: [entry], timestamp: entry.timestamp };
              logGroups.push(currentGroup);
            }
          } else if (entry.type === 'stdout' || entry.type === 'stderr') {
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–≤–æ–¥ –∫ —Ç–µ–∫—É—â–µ–π –≥—Ä—É–ø–ø–µ
            if (currentGroup) {
              currentGroup.entries.push(entry);
            }
          }
        });
      }

      function renderLogList() {
        const listEl = document.getElementById('logList');
        
        if (logGroups.length === 0) {
          listEl.innerHTML = '<div class="empty-state">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ –ª–æ–≥–µ</div>';
          return;
        }

        const html = logGroups.map((group, index) => {
          const firstEntry = group.entries[0];
          const time = new Date(firstEntry.timestamp).toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit', 
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });

          let typeLabel, preview, className;
          
          if (firstEntry.type === 'ai_query') {
            typeLabel = 'ü§ñ AI –ó–∞–ø—Ä–æ—Å';
            preview = firstEntry.user_ai_query;
            className = 'ai-query';
          } else if (firstEntry.type === 'stdin') {
            typeLabel = '‚ö° –ö–æ–º–∞–Ω–¥–∞';
            preview = firstEntry.executed_command;
            className = 'stdin';
          } else {
            typeLabel = 'üì§ –í—ã–≤–æ–¥';
            preview = (firstEntry.terminal_output || '').substring(0, 50);
            className = 'stdout';
          }

          return `
            <div class="log-item ${index === currentGroupIndex ? 'active' : ''}" onclick="selectGroup(${index})">
              <div class="log-item-time">${time}</div>
              <div class="log-item-type ${className}">${typeLabel}</div>
              <div class="log-item-preview">${preview}</div>
            </div>
          `;
        }).join('');

        listEl.innerHTML = html;
      }

      function selectGroup(index) {
        if (index < 0 || index >= logGroups.length) return;
        
        currentGroupIndex = index;
        renderLogList(); // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        renderGroupDetails(logGroups[index]);
        updateNavButtons();
      }

      function renderGroupDetails(group) {
        const detailsEl = document.getElementById('entryDetails');
        const titleEl = document.getElementById('contentTitle');
        
        const firstEntry = group.entries[0];
        const time = new Date(firstEntry.timestamp).toLocaleString('ru-RU');
        titleEl.textContent = `–ó–∞–ø–∏—Å—å –æ—Ç ${time}`;

        const html = group.entries.map(entry => {
          let typeLabel, content, className;
          
          switch (entry.type) {
            case 'ai_query':
              typeLabel = 'ü§ñ AI –ó–∞–ø—Ä–æ—Å';
              content = entry.user_ai_query;
              className = 'ai-query';
              break;
            case 'stdin':
              typeLabel = '‚ö° –ö–æ–º–∞–Ω–¥–∞';
              content = entry.executed_command;
              className = 'stdin';
              break;
            case 'stdout':
              typeLabel = 'üì§ –í—ã–≤–æ–¥';
              content = (entry.terminal_output || '').replace(/\x1b\[[0-9;?]*[a-zA-Z]/g, '');
              className = 'stdout';
              break;
            case 'stderr':
              typeLabel = 'üî• –û—à–∏–±–∫–∞';
              content = (entry.terminal_output || '').replace(/\x1b\[[0-9;?]*[a-zA-Z]/g, '');
              className = 'stderr';
              break;
            default:
              return '';
          }

          const entryTime = new Date(entry.timestamp).toLocaleString('ru-RU');
          
          return `
            <div class="entry-card">
              <div class="entry-header">
                <div class="entry-type ${className}">${typeLabel}</div>
                <div class="entry-time">${entryTime}</div>
              </div>
              <div class="entry-content ${className}">${content}</div>
            </div>
          `;
        }).join('');

        detailsEl.innerHTML = html;
      }

      function navigateEntry(direction) {
        const newIndex = currentGroupIndex + direction;
        if (newIndex >= 0 && newIndex < logGroups.length) {
          selectGroup(newIndex);
          
          // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫ –∞–∫—Ç–∏–≤–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
          const activeItem = document.querySelector('.log-item.active');
          if (activeItem) {
            activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      }

      function updateNavButtons() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        prevBtn.disabled = currentGroupIndex <= 0;
        nextBtn.disabled = currentGroupIndex >= logGroups.length - 1;
      }

      function updateNavInfo() {
        const infoEl = document.getElementById('navInfo');
        if (logGroups.length === 0) {
          infoEl.textContent = '–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π';
        } else {
          infoEl.textContent = `${currentGroupIndex + 1} –∏–∑ ${logGroups.length}`;
        }
      }

      function refreshLogs() {
        document.getElementById('navInfo').textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        loadLogs(true); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
      }

      // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
      document.addEventListener('keydown', (e) => {
        if (e.code === 'ArrowUp' || e.code === 'KeyK') {
          e.preventDefault();
          navigateEntry(-1);
        } else if (e.code === 'ArrowDown' || e.code === 'KeyJ') {
          e.preventDefault();
          navigateEntry(1);
        } else if (e.code === 'F5' || (e.ctrlKey && e.code === 'KeyR')) {
          e.preventDefault();
          refreshLogs();
        }
      });

      // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (—É–≤–µ–ª–∏—á–∏–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª)
      setInterval(refreshLogs, 30000);

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
      loadLogs();
    </script>
  </body>
</html>